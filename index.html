<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI News Reader Studio</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles are now handled by theme classes on the root div */
        body { font-family: 'Inter', sans-serif; }
        .bengali-text { font-family: 'Noto Sans Bengali', sans-serif; }
        
        /* Custom Theme Classes */
        .dark-theme { background-color: #0d111c; color: #f8fafc; }
        .light-theme { background-color: #f1f5f9; color: #1e293b; }
        
        /* Neon Button Effect (Red is kept as accent color) */
        .neon-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 0 5px rgba(239, 68, 68, 0);
        }
        .neon-button:hover {
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.6), inset 0 0 5px rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }
        
        /* Audio Visualizer Animation */
        .bar-container { height: 28px; display: flex; align-items: flex-end; gap: 2px; }
        .bar {
            width: 4px;
            background: #ef4444;
            animation: bounce 1s infinite ease-in-out;
            border-radius: 99px;
        }
        .bar:nth-child(1) { height: 14px; animation-delay: 0.1s; }
        .bar:nth-child(2) { height: 24px; animation-delay: 0.2s; }
        .bar:nth-child(3) { height: 18px; animation-delay: 0.3s; }
        .bar:nth-child(4) { height: 28px; animation-delay: 0.4s; }
        .bar:nth-child(5) { height: 20px; animation-delay: 0.5s; }

        @keyframes bounce {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(1.5); }
        }

        /* Custom Scrollbar for all scrollable sections */
        ::-webkit-scrollbar { width: 8px; }
        .dark-theme ::-webkit-scrollbar-track { background: #1e293b; }
        .dark-theme ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark-theme ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .light-theme ::-webkit-scrollbar-track { background: #e2e8f0; }
        .light-theme ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .light-theme ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Header specific gradient and pattern */
        .header-bg-dark {
            background-color: #0b0e16; /* Base dark color */
            background-image: radial-gradient(circle at top right, rgba(239, 68, 68, 0.1), transparent),
                              radial-gradient(circle at bottom left, rgba(59, 130, 246, 0.05), transparent);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .header-bg-light {
            background-color: #ffffff; /* Base light color */
            background-image: radial-gradient(circle at top right, rgba(254, 202, 202, 0.5), transparent),
                              radial-gradient(circle at bottom left, rgba(191, 219, 254, 0.3), transparent);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONSTANTS ---
        const MAX_SCRIPT_LENGTH = 1500; // Hard character limit for stability
        const MAX_RETRIES = 5;
        const PREVIEW_SCRIPT = "Ishan Bangla news e apnake swagato janai"; // Bengali: "Ishan Bangla news welcomes you"

        const speedMap = {
            1: 1.0, // Normal
            2: 1.2, // Brisk
            3: 1.5, // Fast
            4: 1.8, // Urgent
        };
        
        // Helper functions (PCM to WAV conversion and utility)
        const pcmToWav = (pcmData, sampleRate = 24000) => {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, 1, true); // Mono
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length, true);
            const pcmView = new Uint8Array(buffer, 44);
            pcmView.set(pcmData);
            return buffer;
        };

        const writeString = (view, offset, string) => {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        // End Helper functions

        const App = () => {
            // Initialize API key state by checking localStorage
            const [apiKey, setApiKey] = React.useState(() => {
                return localStorage.getItem('geminiApiKey') || '';
            });
            
            const [script, setScript] = React.useState('');
            // MODIFIED: Load default category from localStorage
            const [category, setCategory] = React.useState(() => {
                return localStorage.getItem('defaultCategory') || 'Breaking News';
            });
            // MODIFIED: Load default voice from localStorage
            const [voice, setVoice] = React.useState(() => {
                return localStorage.getItem('defaultVoice') || 'Puck';
            });
            const [speedLevel, setSpeedLevel] = React.useState(2); // Discrete level: 1, 2, 3, 4
            const [pitch, setPitch] = React.useState('normal'); // New state: low, normal, high
            const [targetLanguage, setTargetLanguage] = React.useState('auto'); // New state: auto, bengali, english
            // Initialize theme state by checking localStorage
            const [theme, setTheme] = React.useState(() => {
                return localStorage.getItem('appTheme') || 'dark';
            });
            
            const [loading, setLoading] = React.useState(false);
            const [audioSrc, setAudioSrc] = React.useState(null);
            const [error, setError] = React.useState('');
            const [showSettings, setShowSettings] = React.useState(false);
            
            // New states for voice preview
            const [previewAudioSrc, setPreviewAudioSrc] = React.useState(null);
            const [previewingVoice, setPreviewingVoice] = React.useState(null);

            // --- Theme Setup ---
            const isDark = theme === 'dark';
            const bgNav = isDark ? 'header-bg-dark border-slate-800' : 'header-bg-light border-slate-200'; // Updated for new header styles
            const bgCard = isDark ? 'bg-[#1f2937] border-slate-800' : 'bg-white border-slate-200 shadow-lg';
            const textHeader = isDark ? 'text-white' : 'text-slate-900';
            const textPrimary = isDark ? 'text-slate-100' : 'text-slate-800';
            const textMuted = isDark ? 'text-slate-400' : 'text-slate-500';
            const bgInput = isDark ? 'bg-[#11141f] border-slate-800 text-white placeholder:text-slate-600' : 'bg-slate-50 border-slate-300 text-slate-900 placeholder:text-slate-400';
            const borderSubtle = isDark ? 'border-slate-700' : 'border-slate-300';
            const bgControlHover = isDark ? 'hover:bg-[#323f53]' : 'hover:bg-slate-200';
            // --- End Theme Setup ---

            // Utility function to handle theme change and persistence
            const handleThemeChange = (newTheme) => {
                setTheme(newTheme);
                localStorage.setItem('appTheme', newTheme);
            };
            
            // Utility function to handle category change and persistence
            const handleCategoryChange = (newCategory) => {
                setCategory(newCategory);
                localStorage.setItem('defaultCategory', newCategory);
            };

            // Utility function to handle voice change and persistence
            const handleVoiceChange = (newVoice) => {
                setVoice(newVoice);
                localStorage.setItem('defaultVoice', newVoice);
            };


            // Expanded Gemini Voice Personas (UPDATED WITH BENGALI NAMES AND NEW FEMALE VOICES)
            const voices = [
                { id: 'general', title: 'Standard Broadcast' },
                { name: 'Puck', label: 'Anirban (M)', desc: 'Balanced & Neutral', type: 'general' },
                { name: 'Kore', label: 'Sumita (F)', desc: 'Calm & Professional', type: 'general' },
                // NEW: Versatile Female Voice
                { name: 'Callirrhoe', label: 'Sanjana (F)', desc: 'Versatile, Easy-going, excellent for varied topics', type: 'general' },
                
                { id: 'serious', title: 'Crime & Impact' },
                // Fenrir is used for aggressive/confrontational tone
                { name: 'Fenrir', label: 'Confrontational Anchor (M)', desc: 'Rough, Intense, and Highly Opinionated', type: 'serious' },
                { name: 'Charon', label: 'Arijit (M)', desc: 'Deep, Grave, Serious Crime Desk', type: 'serious' },
                { name: 'Orus', label: 'Prosenjit (M)', desc: 'Firm & Commanding for Politics', type: 'serious' },
                { name: 'Algenib', label: 'Ranit (M)', desc: 'Gravelly, Deep, for Urgent Situations', type: 'serious' },

                { id: 'solemn', title: 'Memorial & Solemn' },
                { name: 'Vindemiatrix', label: 'Arpita (F)', desc: 'Gentle, Subdued, for Memorials or Tragedy', type: 'solemn' },


                { id: 'energetic', title: 'Energy & Lifestyle' },
                { name: 'Aoede', label: 'Sunaina (F)', desc: 'Bright & Engaging, perfect for entertainment', type: 'energetic' },
                { name: 'Zephyr', label: 'Ritika (F)', desc: 'High Energy & Fast, youthful voice for youth/sports', type: 'energetic' },
                // NEW: Energetic Female Voice
                { name: 'Leda', label: 'Poulomi (F)', desc: 'Youthful, Lively, great for dynamic segments', type: 'energetic' },
            ];

            // Segment types remain the same as the last update
            const categories = [
                { id: 'Breaking News', label: 'Breaking News', icon: 'fa-bolt', color: 'bg-red-700', promptMod: 'extremely urgent, fast-paced, and serious. Emphasize the immediate importance.' },
                { id: 'Sports', label: 'Sports', icon: 'fa-trophy', color: 'bg-green-600', promptMod: 'energetic, exciting, dynamic, and highly passionate. Use an elevated voice.' },
                { id: 'Politics', label: 'Politics', icon: 'fa-landmark', color: 'bg-yellow-600', promptMod: 'authoritative, analytical, clear, and slightly formal. Maintain a serious tone.' },
                { id: 'Entertainment & Lifestyle', label: 'Lifestyle', icon: 'fa-masks-theater', color: 'bg-emerald-700', promptMod: 'engaging, light-hearted, friendly, and conversational. Use a warm tone.' },
                { id: 'Business & Economy', label: 'Business', icon: 'fa-chart-line', color: 'bg-sky-600', promptMod: 'authoritative, clear, and complex. Use a confident, measured pace.' },
                { id: 'Crime & Law', label: 'Crime & Law', icon: 'fa-handcuffs', color: 'bg-amber-800', promptMod: 'grave, serious, and storytelling. Maintain a slow, deliberate pace.' },
                { id: 'Community & Local News', label: 'Local News', icon: 'fa-people-group', color: 'bg-pink-600', promptMod: 'warm, localized, and friendly. Focus on community importance.' },
                { id: 'Weather', label: 'Weather', icon: 'fa-cloud-sun', color: 'bg-purple-700', promptMod: 'calm, clear, and helpful. Maintain a pleasant, informative tone.' },
                { id: 'Education & Youth', label: 'Education', icon: 'fa-graduation-cap', color: 'bg-indigo-700', promptMod: 'optimistic, encouraging, and clear. Use an inspiring and positive tone.' },
                { id: 'Awareness', label: 'Awareness', icon: 'fa-hand-holding-heart', color: 'bg-blue-800', promptMod: 'inspirational, clear, and persuasive. Use an engaging and motivational voice.' },
                { id: 'Social & Cultural', label: 'Culture', icon: 'fa-brush', color: 'bg-gray-800', promptMod: 'reflective, respectful, and engaging. Describe cultural details with appreciation.' },
            ];
            
            const getCategoryColorClass = (id) => {
                return categories.find(c => c.id === id)?.color || 'bg-red-700';
            };


            const pitchOptions = [
                { id: 'low', label: 'Low', desc: 'Deep and Resonant' },
                { id: 'normal', label: 'Normal', desc: 'Default Voice Pitch' },
                { id: 'high', label: 'High', desc: 'Elevated and Energetic' },
            ];

            const languageOptions = [
                { id: 'auto', label: 'Auto Detect', desc: 'Best for mixed scripts' },
                { id: 'bengali', label: 'Bengali', desc: 'Prioritize Bengali pronunciation' },
                { id: 'english', label: 'English (US)', desc: 'Prioritize American English' },
            ];


            const getSpeedInstruction = (level) => {
                if (level === 1) return "normal, professional conversational pace";
                if (level === 2) return "brisk, slightly faster pace";
                if (level === 3) return "very fast, urgent, and rapid pace";
                if (level === 4) return "extremely fast, urgent, and highly rapid pace";
                return "normal, professional conversational pace";
            };
            
            const handleScriptChange = (e) => {
                const newScript = e.target.value;
                if (newScript.length <= MAX_SCRIPT_LENGTH) {
                    setScript(newScript);
                }
            };
            
            // --- Voice Preview Function ---
            const generateVoicePreview = async (voiceName) => {
                if (!apiKey) {
                    setShowSettings(true);
                    setError('Please save your API Key in settings first.');
                    return;
                }
                setPreviewingVoice(voiceName);
                setPreviewAudioSrc(null); 

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: PREVIEW_SCRIPT }] }],
                            generationConfig: {
                                responseModalities: ["AUDIO"],
                                speechConfig: {
                                    voiceConfig: {
                                        prebuiltVoiceConfig: {
                                            voiceName: voiceName
                                        }
                                    }
                                }
                            }
                        })
                    });

                    const data = await response.json();
                    
                    const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                    
                    if (inlineData) {
                        const binaryString = window.atob(inlineData.data);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }

                        const wavBuffer = pcmToWav(bytes);
                        const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(blob);
                        
                        setPreviewAudioSrc(audioUrl);
                        
                        const audio = new Audio(audioUrl);
                        audio.onended = () => {
                            setPreviewingVoice(null); 
                            setPreviewAudioSrc(null); 
                        };
                        audio.play().catch(e => {
                            console.error("Autoplay prevented:", e);
                            setPreviewingVoice(null);
                        });
                        
                    } else {
                        throw new Error("No audio data received for preview.");
                    }

                } catch (err) {
                    setError("Preview failed: " + err.message);
                    setPreviewingVoice(null);
                }
            };
            // --- End Voice Preview Function ---


            // --- Main Voiceover Generation Function (with Backoff) ---
            const generateVoiceover = async () => {
                if (!apiKey) {
                    setShowSettings(true);
                    setError('Please save your API Key in settings first.');
                    return;
                }
                if (!script) {
                    setError('Please enter a news script.');
                    return;
                }
                if (script.length > MAX_SCRIPT_LENGTH) {
                    setError(`Script is too long. Max allowed characters is ${MAX_SCRIPT_LENGTH}.`);
                    return;
                }
                
                setLoading(true);
                setError('');
                setAudioSrc(null);

                const selectedCategory = categories.find(c => c.id === category);
                const speedText = getSpeedInstruction(speedLevel);
                const pitchInstruction = pitch === 'low' ? 'with a deep, low pitch' : pitch === 'high' ? 'with a high, energetic pitch' : 'with a natural, normal pitch';
                const languageInstruction = targetLanguage === 'bengali' ? 'Strictly prioritize Bengali pronunciation.' : targetLanguage === 'english' ? 'Strictly prioritize American English pronunciation.' : 'Detect the language (Bengali or English) automatically.';
                
                let toneInstruction = selectedCategory.promptMod;

                // CRITICAL TONE ADJUSTMENT FOR THE CONFRONTATIONAL VOICE
                if (voice === 'Fenrir') {
                    toneInstruction = 'extremely rough, gravelly, and highly opinionated. Use a deeply tense and dramatic delivery, like a debate anchor who is highly agitated and aggressive.';
                }
                
                const finalPrompt = `
                    You are a professional Bengali news anchor for "AI News Studio".
                    Your task is to read the following script aloud.
                    
                    Context: This is a ${category} segment.
                    Tone Instruction: Read this in an ${toneInstruction} tone, ${pitchInstruction}.
                    Pace Instruction: Read this at a ${speedText}.
                    Language Instruction: ${languageInstruction}
                    
                    Script:
                    "${script}"
                `;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: finalPrompt }] }],
                                generationConfig: {
                                    responseModalities: ["AUDIO"],
                                    speechConfig: {
                                        voiceConfig: {
                                            prebuiltVoiceConfig: {
                                                voiceName: voice
                                            }
                                        }
                                    }
                                }
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            let errorMessage = data.error?.message || `API call failed with status: ${response.status}`;
                            // Check for specific 429 rate limit or similar errors
                            if (response.status === 429 || errorMessage.includes('quota')) {
                                throw new Error(`API Quota Reached. Please check your project billing or wait for the quota to reset. Error: ${errorMessage}`);
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
                        
                        if (inlineData) {
                            const binaryString = window.atob(inlineData.data);
                            const len = binaryString.length;
                            const bytes = new Uint8Array(len);
                            for (let i = 0; i < len; i++) {
                                bytes[i] = binaryString.charCodeAt(i);
                            }

                            const wavBuffer = pcmToWav(bytes);
                            const blob = new Blob([wavBuffer], { type: 'audio/wav' });
                            const audioUrl = URL.createObjectURL(blob);
                            setAudioSrc(audioUrl);
                            setLoading(false);
                            return; 
                        } else {
                            throw new Error("No audio data received. The model might have refused the request.");
                        }

                    } catch (err) {
                        if (err.message.includes('Quota Reached') || attempt === MAX_RETRIES - 1) {
                            // Display the specific quota message or the last error
                            setError(err.message.includes('Quota Reached') ? err.message : `Failed after ${MAX_RETRIES} attempts: ${err.message}`);
                            setLoading(false);
                            return;
                        }
                        
                        const waitTime = Math.pow(2, attempt) * 1000;
                        await delay(waitTime);
                    }
                }
            };
            // --- End Main Voiceover Generation Function ---


            // --- Component Rendering ---
            return (
                <div className={`min-h-screen font-sans selection:bg-red-500 selection:text-white ${isDark ? 'dark-theme' : 'light-theme'}`}>
                    
                    {/* Top Navigation Bar (MODERNIZED) */}
                    <nav className={`${bgNav} border-b ${isDark ? 'border-slate-800' : 'border-slate-200'} sticky top-0 z-20 transition-colors`}>
                        <div className="max-w-7xl mx-auto px-6 h-24 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                {/* Dynamic Logo Icon */}
                                <div className="h-14 w-14 flex items-center justify-center rounded-xl shadow-2xl shadow-red-500/50 ring-2 ring-red-600 bg-red-500 text-white transform rotate-3 transition-transform hover:rotate-0">
                                    <i className="fa-solid fa-satellite-dish text-2xl"></i>
                                </div>
                                <div>
                                    <h1 className={`font-extrabold text-3xl leading-snug tracking-tighter ${textHeader} transition-colors`}>
                                        AI News Studio
                                    </h1>
                                    <p className={`text-sm ${textMuted} font-medium uppercase tracking-[0.2em] transition-colors`}>
                                        <span className="text-red-500 font-bold">ISHAN BANGLA</span> Broadcast Suite
                                    </p>
                                </div>
                            </div>
                            <button 
                                onClick={() => setShowSettings(true)}
                                className={`h-10 w-10 rounded-full flex items-center justify-center transition-all duration-300 shadow-md
                                    ${apiKey 
                                        ? (isDark ? 'bg-slate-800 text-slate-400 hover:bg-slate-700/80 hover:text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-800') 
                                        : 'bg-red-500/10 text-red-500 ring-2 ring-red-500 animate-pulse'
                                    }`}
                                title="Settings"
                            >
                                <i className="fa-solid fa-gear"></i>
                            </button>
                        </div>
                    </nav>

                    <main className="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* LEFT PANEL: Controls (Consolidated and Scrollable) */}
                        <div className="lg:col-span-4 space-y-8">
                            
                            {/* Segment Selector (FIXED HEIGHT FOR VISIBILITY) */}
                            <div className={`${bgCard} p-6 rounded-2xl shadow-xl border ${borderSubtle}`}>
                                <h3 className="text-xs font-bold text-red-500 uppercase tracking-widest mb-4">SEGMENT TYPE</h3>
                                <div className="grid grid-cols-2 gap-3 max-h-[350px] overflow-y-auto pr-3">
                                    {categories.map((cat) => {
                                        const isSelected = category === cat.id;
                                        return (
                                            <button 
                                                key={cat.id}
                                                // MODIFIED: Use utility function to save and set category
                                                onClick={() => handleCategoryChange(cat.id)}
                                                className={`p-4 rounded-xl text-sm font-semibold transition-all flex items-center gap-3 shadow-md
                                                    ${isSelected 
                                                    ? `${cat.color} border-2 border-white text-white shadow-xl shadow-red-900/50 neon-button` // Use the specific color
                                                    : `${isDark ? 'bg-[#293547] border border-[#2e3a4e] text-slate-300' : 'bg-slate-100 border border-slate-300 text-slate-700'} ${bgControlHover}`
                                                }`}
                                            >
                                                <i className={`fa-solid ${cat.icon} text-lg`}></i>
                                                {cat.label}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* Consolidated Fine-Tuning Controls (Pace, Pitch, Language) */}
                            <div className={`${bgCard} p-6 rounded-2xl shadow-xl border ${borderSubtle}`}>
                                
                                <h3 className="text-xs font-bold text-red-500 uppercase tracking-widest mb-4 border-b pb-2 ${borderSubtle}">FINE TUNING</h3>

                                {/* 1. PACE CONTROL */}
                                <div className="mb-6">
                                    <h4 className={`text-sm font-semibold ${textPrimary} mb-2`}>Speaking Pace</h4>
                                    <div className="grid grid-cols-4 gap-2">
                                        {[1, 2, 3, 4].map(level => (
                                            <button
                                                key={level}
                                                onClick={() => setSpeedLevel(level)}
                                                className={`py-2 rounded-xl text-lg font-extrabold transition-all border
                                                    ${speedLevel === level 
                                                    ? 'bg-red-700 border-red-500 text-white shadow-red-900/40 neon-button' 
                                                    : `${isDark ? 'bg-[#293547] border-[#2e3a4e] text-slate-300' : 'bg-slate-100 border-slate-300 text-slate-700'} ${bgControlHover}`
                                                }`}
                                                title={getSpeedInstruction(level).split(',')[0]}
                                            >
                                                {level}x
                                            </button>
                                        ))}
                                    </div>
                                    <p className={`text-xs ${textMuted} mt-2 text-center`}>
                                        Current: <span className="text-red-400 font-semibold">{getSpeedInstruction(speedLevel).split(',')[0]}</span>
                                    </p>
                                </div>

                                {/* 2. PITCH CONTROL */}
                                <div className="mb-6 border-t pt-4 ${borderSubtle}">
                                    <h4 className={`text-sm font-semibold ${textPrimary} mb-2`}>Voice Pitch</h4>
                                    <div className="grid grid-cols-3 gap-3">
                                        {pitchOptions.map(p => (
                                            <button
                                                key={p.id}
                                                onClick={() => setPitch(p.id)}
                                                className={`p-3 rounded-xl text-sm font-semibold transition-all flex flex-col items-center justify-center shadow-md
                                                    ${pitch === p.id 
                                                    ? 'bg-red-700 border-red-500 text-white shadow-red-900/40 neon-button' 
                                                    : `${isDark ? 'bg-[#293547] border border-[#2e3a4e] text-slate-300' : 'bg-slate-100 border border-slate-300 text-slate-700'} ${bgControlHover}`
                                                }`}
                                            >
                                                <i className={`fa-solid ${p.id === 'low' ? 'fa-volume-down' : p.id === 'high' ? 'fa-volume-up' : 'fa-volume-mute'} text-lg mb-1`}></i>
                                                <span className="text-xs">{p.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* 3. LANGUAGE HINT */}
                                <div className="border-t pt-4 ${borderSubtle}">
                                    <h4 className={`text-sm font-semibold ${textPrimary} mb-2`}>Pronunciation Hint</h4>
                                    <div className="grid grid-cols-3 gap-3">
                                        {languageOptions.map(lang => (
                                            <button 
                                                key={lang.id}
                                                onClick={() => setTargetLanguage(lang.id)}
                                                className={`p-3 rounded-xl text-sm font-semibold transition-all flex flex-col items-center justify-center text-center shadow-md
                                                    ${targetLanguage === lang.id 
                                                    ? 'bg-red-700 border-red-500 text-white shadow-red-900/40 neon-button' 
                                                    : `${isDark ? 'bg-[#293547] border border-[#2e3a4e] text-slate-300' : 'bg-slate-100 border border-slate-300 text-slate-700'} ${bgControlHover}`
                                                }`}
                                            >
                                                <i className={`fa-solid ${lang.id === 'bengali' ? 'fa-bahai' : lang.id === 'english' ? 'fa-a' : 'fa-language'} text-lg mb-1`}></i>
                                                <span className="text-xs">{lang.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* CENTER/RIGHT PANEL: Script & Output */}
                        <div className="lg:col-span-8 flex flex-col h-full gap-6">
                            
                            {/* Script Editor */}
                            <div className={`flex-1 ${bgCard} rounded-2xl border ${borderSubtle} shadow-2xl overflow-hidden flex flex-col`}>
                                <div className={`${isDark ? 'bg-[#11141f]' : 'bg-slate-50'} px-6 py-3 border-b ${borderSubtle} flex justify-between items-center`}>
                                    <span className={`text-sm font-bold ${textMuted} uppercase tracking-wider`}>Teleprompter Script</span>
                                    <span className={`text-xs font-medium ${script.length > MAX_SCRIPT_LENGTH ? 'text-red-400' : textMuted}`}>
                                        {script.length} / {MAX_SCRIPT_LENGTH} chars
                                    </span>
                                </div>
                                <textarea 
                                    className={`flex-1 w-full bg-transparent p-6 outline-none resize-none text-xl leading-relaxed ${textPrimary} bengali-text ${isDark ? 'placeholder:text-slate-600' : 'placeholder:text-slate-400'}`}
                                    placeholder="Enter your news script here (Bengali or English)..."
                                    value={script}
                                    onChange={handleScriptChange}
                                ></textarea>
                            </div>

                            {/* Error Toast */}
                            {error && (
                                <div className="bg-red-500/10 border border-red-700 text-red-400 px-6 py-4 rounded-xl text-sm flex items-center gap-3 animate-fade-in shadow-lg shadow-red-900/20">
                                    <i className="fa-solid fa-triangle-exclamation text-lg"></i>
                                    <span className="font-semibold">{error}</span>
                                </div>
                            )}

                            {/* Action Area */}
                            <div className={`${bgCard} rounded-2xl border ${borderSubtle} p-6 shadow-2xl`}>
                                
                                {/* Audio Player Toggle */}
                                {!audioSrc && (
                                    <button 
                                        onClick={generateVoiceover}
                                        disabled={loading || script.length === 0 || script.length > MAX_SCRIPT_LENGTH || !apiKey}
                                        className={`w-full py-4 rounded-xl font-bold text-lg shadow-xl transition-all flex items-center justify-center gap-3
                                            ${(loading || script.length === 0 || script.length > MAX_SCRIPT_LENGTH || !apiKey)
                                            ? `${isDark ? 'bg-slate-700 text-slate-400' : 'bg-slate-300 text-slate-500'} cursor-not-allowed` 
                                            : 'bg-red-700 hover:bg-red-600 text-white shadow-red-900/40 neon-button'}
                                        `}
                                    >
                                        {loading ? (
                                            <>
                                                <i className="fa-solid fa-circle-notch fa-spin"></i>
                                                Broadcasting...
                                            </>
                                        ) : (
                                            <>
                                                <i className="fa-solid fa-bullhorn text-xl"></i>
                                                Generate Full Voiceover
                                            </>
                                        )}
                                    </button>
                                )}
                                
                                {/* Voice Selector (Moved to the bottom for better layout) */}
                                <div className={`${bgCard} p-6 rounded-2xl shadow-xl border ${borderSubtle} mt-6`}>
                                    <h3 className="text-xs font-bold text-red-500 uppercase tracking-widest mb-4">VOICE TALENT</h3>
                                    <div className="space-y-2 max-h-[350px] overflow-y-auto pr-2 custom-scrollbar">
                                        {voices.map((v, i) => {
                                            if (v.title) return (
                                                <div key={i} className={`text-[10px] font-bold ${isDark ? 'text-slate-500' : 'text-slate-400'} uppercase pt-4 pb-1 tracking-widest`}>{v.title}</div>
                                            );
                                            
                                            const isPreviewLoading = previewingVoice === v.name;
                                            
                                            return (
                                                <div 
                                                    key={v.name}
                                                    className={`w-full p-3 rounded-lg border transition-all flex items-center justify-between group cursor-pointer
                                                        ${voice === v.name 
                                                        ? 'bg-red-500/10 border-red-600 ring-1 ring-red-600 shadow-md shadow-red-900/10' 
                                                        : isDark ? 'bg-[#242c38] border-slate-800 hover:border-slate-700 hover:bg-[#2e3644]' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'
                                                    }`}
                                                    // MODIFIED: Use utility function to save and set voice
                                                    onClick={() => handleVoiceChange(v.name)}
                                                >
                                                    <div className="flex-1">
                                                        <div className={`text-sm font-semibold ${voice === v.name ? 'text-red-400' : textPrimary}`}>{v.label}</div>
                                                        <div className={`text-xs ${textMuted} mt-0.5`}>{v.desc}</div>
                                                    </div>
                                                    
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); generateVoicePreview(v.name); }}
                                                        disabled={isPreviewLoading}
                                                        className={`ml-3 px-3 py-1 text-xs font-medium rounded-full flex items-center gap-1 transition-colors
                                                            ${isPreviewLoading 
                                                                ? 'bg-red-800 text-white cursor-not-allowed' 
                                                                : 'bg-red-600 text-white hover:bg-red-500 neon-button'
                                                            }`}
                                                    >
                                                        {isPreviewLoading ? (
                                                            <>
                                                                <i className="fa-solid fa-spinner fa-spin"></i>
                                                                Load
                                                            </>
                                                        ) : (
                                                            <>
                                                                <i className="fa-solid fa-volume-high"></i>
                                                                {voice === v.name ? 'Selected' : 'Preview'}
                                                            </>
                                                        )}
                                                    </button>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>


                                {/* Audio Player */}
                                {audioSrc && (
                                    <div className="animate-fade-in">
                                        <div className={`flex items-center justify-between mb-5 pb-5 border-b ${borderSubtle}`}>
                                            <div className="flex items-center gap-4">
                                                <div className="h-12 w-12 bg-green-500/10 rounded-full flex items-center justify-center border border-green-700 text-green-500 shadow-md shadow-green-900/20">
                                                    <i className="fa-solid fa-check text-xl"></i>
                                                </div>
                                                <div>
                                                    <h3 className={`font-bold ${textPrimary} text-xl`}>Broadcast Complete</h3>
                                                    <p className={`text-sm ${textMuted}`}>
                                                        Voice: {voices.find(v => v.name === voice)?.label} â€¢ Pace: {speedLevel}x
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="bar-container">
                                                <div className="bar"></div><div className="bar"></div><div className="bar"></div>
                                                <div className="bar"></div><div className="bar"></div>
                                            </div>
                                        </div>
                                        
                                        <audio controls src={audioSrc} className="w-full h-10 mb-6 bg-slate-800 rounded-lg" autoPlay></audio>
                                        
                                        <div className="grid grid-cols-2 gap-4">
                                            {/* MODIFIED: Reset state to allow new script input immediately */}
                                            <button 
                                                onClick={() => setAudioSrc(null)} 
                                                className={`py-3 rounded-xl text-sm font-semibold ${isDark ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-slate-200 text-slate-700 hover:bg-slate-300'} transition-colors`}
                                            >
                                                <i className="fa-solid fa-file-circle-plus mr-2"></i> New Script
                                            </button>
                                            <a href={audioSrc} download={`news-${category.toLowerCase().replace(/[\s&]+/g, '-')}-${voice}.wav`} className="flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-semibold bg-red-600 text-white hover:bg-red-500 transition-colors neon-button">
                                                <i className="fa-solid fa-download"></i> Download WAV
                                            </a>
                                        </div>
                                    </div>
                                )}
                            </div>

                        </div>
                    </main>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                            <div className={`${bgCard} rounded-2xl border ${borderSubtle} w-full max-w-md shadow-2xl overflow-hidden`}>
                                <div className={`p-6 border-b ${borderSubtle} flex justify-between items-center ${isDark ? 'bg-[#11141f]' : 'bg-slate-50'}`}>
                                    <h2 className={`text-xl font-bold ${textHeader}`}>Studio Settings</h2>
                                    <button onClick={() => setShowSettings(false)} className={`${textMuted} hover:text-red-400 transition-colors`}>
                                        <i className="fa-solid fa-xmark text-xl"></i>
                                    </button>
                                </div>
                                <div className="p-6 space-y-6">
                                    
                                    {/* Theme Toggle */}
                                    <div>
                                        <label className="block text-xs font-bold text-red-500 uppercase tracking-widest mb-2">Theme</label>
                                        <div className="flex items-center space-x-4">
                                            <button 
                                                onClick={() => handleThemeChange('dark')} // Use utility function to save theme
                                                className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all ${isDark ? 'bg-red-600 text-white' : `${isDark ? 'text-slate-400 hover:bg-slate-700' : 'text-slate-600 bg-slate-100 hover:bg-slate-200'}`}`}
                                            >
                                                <i className="fa-solid fa-moon"></i> Dark
                                            </button>
                                            <button 
                                                onClick={() => handleThemeChange('light')} // Use utility function to save theme
                                                className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all ${!isDark ? 'bg-red-600 text-white' : `${isDark ? 'text-slate-400 hover:bg-slate-700' : 'text-slate-600 bg-slate-100 hover:bg-slate-200'}`}`}
                                            >
                                                <i className="fa-solid fa-sun"></i> Light
                                            </button>
                                        </div>
                                    </div>

                                    {/* API Key Instructions (IMPROVED) */}
                                    <div>
                                        <label className="block text-xs font-bold text-red-500 uppercase tracking-widest mb-2">Google Gemini API Key</label>
                                        <div className="relative">
                                            <i className={`fa-solid fa-key absolute left-3 top-3.5 ${textMuted}`}></i>
                                            <input 
                                                type="password" 
                                                className={`w-full rounded-lg py-3 pl-10 pr-4 text-sm focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none transition-all ${bgInput}`}
                                                placeholder="Paste key starting with AIza..."
                                                value={apiKey}
                                                // MODIFIED: Save key to local storage on every change
                                                onChange={(e) => {
                                                    const newKey = e.target.value;
                                                    setApiKey(newKey);
                                                    localStorage.setItem('geminiApiKey', newKey);
                                                }}
                                            />
                                        </div>
                                        <div className={`text-xs ${textMuted} mt-3 space-y-2 p-3 ${isDark ? 'bg-[#11141f] border border-slate-800 rounded-lg' : 'bg-slate-50 border border-slate-200 rounded-lg'}`}>
                                            <p className="font-semibold text-red-400">How to get your API Key:</p>
                                            <ol className="list-decimal list-inside ml-2 space-y-1">
                                                <li>Go to the <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-red-400 hover:underline font-normal">Google AI Studio Key Page</a>.</li>
                                                <li>Click **"Create API key"** and copy the generated string.</li>
                                                <li>Paste the key into the field above and click **Save**.</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                <div className={`p-4 ${isDark ? 'bg-[#11141f]' : 'bg-slate-50'} flex justify-end`}>
                                    <button 
                                        onClick={() => setShowSettings(false)}
                                        className="px-6 py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-500 transition-colors neon-button"
                                    >
                                        Save & Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
